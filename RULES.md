# Community Rules System

LLM Firewall now supports a flexible, community-driven rules system that allows you to customize PII detection patterns beyond the built-in defaults.

## üöÄ Quick Start

### Using Community Rules

1. **Enable Rules in Configuration**
   ```json
   {
     "rules": {
       "enabled": true,
       "rulesDir": "rules",
       "minConfidence": 0.7,
       "enabledCategories": ["personal", "financial", "technical"]
     }
   }
   ```

2. **Test Enhanced Detection**
   ```bash
   llm-firewall test-enhanced --text \"API key: sk-1234567890abcdef1234567890abcdef\"\n   ```

3. **List Available Rules**
   ```bash\n   llm-firewall rules list\n   ```

## üìÅ Directory Structure

```
rules/\n‚îú‚îÄ‚îÄ schema.json              # JSON schema for rule validation\n‚îú‚îÄ‚îÄ core/                     # Built-in rules (maintained by LLM Firewall)\n‚îÇ   ‚îú‚îÄ‚îÄ basic-pii.json\n‚îÇ   ‚îî‚îÄ‚îÄ api-keys.json\n‚îú‚îÄ‚îÄ community/               # Community-contributed rules\n‚îÇ   ‚îú‚îÄ‚îÄ README.md\n‚îÇ   ‚îî‚îÄ‚îÄ financial-extended.json\n‚îî‚îÄ‚îÄ vendor/                  # Vendor-specific rules\n    ‚îî‚îÄ‚îÄ (your custom rules)\n```

## üéØ Rule Categories

- **personal**: Personal identifiers (SSN, emails, phone numbers)\n- **financial**: Financial information (credit cards, bank accounts, crypto wallets)\n- **medical**: Medical identifiers (patient IDs, medical records)\n- **technical**: Technical secrets (API keys, tokens, passwords)\n- **custom**: Organization-specific patterns\n\n## üìã Rule Schema\n\nEach rule file follows this structure:\n\n```json\n{\n  \"name\": \"Rule Set Name\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Description of what this rule set detects\",\n  \"author\": \"Your Name\",\n  \"tags\": [\"category\", \"type\"],\n  \"rules\": [\n    {\n      \"id\": \"unique_rule_id\",\n      \"name\": \"Human Readable Name\",\n      \"description\": \"What this rule detects\",\n      \"pattern\": \"\\\\bregex-pattern\\\\b\",\n      \"flags\": \"g\",\n      \"replacement\": \"[REDACTED_TYPE]\",\n      \"confidence\": 0.95,\n      \"category\": \"technical\",\n      \"severity\": \"critical\",\n      \"enabled\": true,\n      \"testCases\": [\n        {\n          \"input\": \"Test input with sensitive data\",\n          \"expected\": \"Test input with [REDACTED_TYPE]\",\n          \"shouldMatch\": true\n        }\n      ]\n    }\n  ]\n}\n```\n\n## üîß CLI Commands\n\n### Rule Management\n\n```bash\n# List all rules\nllm-firewall rules list\n\n# Filter by category\nllm-firewall rules list --category financial\n\n# Show only enabled rules\nllm-firewall rules list --enabled\n\n# Validate a rule file\nllm-firewall rules validate path/to/rules.json\n\n# Test rule file with test cases\nllm-firewall rules test-rules path/to/rules.json\n\n# Enable/disable specific rules\nllm-firewall rules enable rule-id\nllm-firewall rules disable rule-id\n```\n\n### Testing\n\n```bash\n# Test with enhanced detection\nllm-firewall test-enhanced --text \"Your sensitive text here\"\n\n# Test with custom config\nllm-firewall test-enhanced --config custom-config.json\n```\n\n## üìö Built-in Rules\n\n### Core PII Detection (`rules/core/basic-pii.json`)\n- US Social Security Numbers\n- Credit Card Numbers\n- Email Addresses\n- US Phone Numbers\n- IPv4 Addresses\n\n### API Keys Detection (`rules/core/api-keys.json`)\n- OpenAI API Keys (`sk-...`)\n- Anthropic API Keys (`sk-ant-api03-...`)\n- Stripe API Keys (`pk_`, `sk_`)\n- AWS Access Keys (`AKIA...`)\n- GitHub Tokens (`ghp_...`)\n- Google API Keys (`AIza...`)\n\n### Extended Financial (`rules/community/financial-extended.json`)\n- IBAN Numbers\n- SWIFT/BIC Codes\n- Bitcoin Wallet Addresses\n- Ethereum Wallet Addresses\n- US Routing Numbers\n\n## üèóÔ∏è Creating Custom Rules\n\n### 1. Create Your Rule File\n\n```json\n{\n  \"name\": \"My Organization Rules\",\n  \"version\": \"1.0.0\",\n  \"description\": \"Custom PII patterns for Acme Corp\",\n  \"author\": \"Security Team\",\n  \"tags\": [\"custom\", \"organizational\"],\n  \"rules\": [\n    {\n      \"id\": \"employee_id\",\n      \"name\": \"Employee ID\",\n      \"description\": \"Detects employee IDs in format EMP-XXXXXX\",\n      \"pattern\": \"\\\\bEMP-\\\\d{6}\\\\b\",\n      \"flags\": \"g\",\n      \"replacement\": \"[REDACTED_EMPLOYEE_ID]\",\n      \"confidence\": 0.95,\n      \"category\": \"custom\",\n      \"severity\": \"medium\",\n      \"enabled\": true,\n      \"testCases\": [\n        {\n          \"input\": \"Employee EMP-123456 submitted report\",\n          \"expected\": \"Employee [REDACTED_EMPLOYEE_ID] submitted report\",\n          \"shouldMatch\": true\n        },\n        {\n          \"input\": \"Temperature: 123456 degrees\",\n          \"expected\": \"Temperature: 123456 degrees\",\n          \"shouldMatch\": false\n        }\n      ]\n    }\n  ]\n}\n```\n\n### 2. Validate Your Rules\n\n```bash\nllm-firewall rules validate my-rules.json\n```\n\n### 3. Test Your Rules\n\n```bash\nllm-firewall rules test-rules my-rules.json\n```\n\n### 4. Place in Rules Directory\n\n```bash\ncp my-rules.json rules/vendor/\n```\n\n## ‚öôÔ∏è Configuration\n\n### Rules Configuration Options\n\n```json\n{\n  \"rules\": {\n    \"enabled\": true,                    // Enable community rules system\n    \"rulesDir\": \"rules\",                // Path to rules directory\n    \"autoReload\": false,                // Auto-reload rules on file changes\n    \"minConfidence\": 0.7,               // Minimum confidence threshold\n    \"enabledCategories\": [              // Only load rules from these categories\n      \"personal\",\n      \"financial\", \n      \"technical\"\n    ],\n    \"disabledRules\": [                  // Specific rule IDs to disable\n      \"some_rule_id\"\n    ]\n  }\n}\n```\n\n### Environment Variables\n\n```bash\nexport LLM_FIREWALL_RULES_ENABLED=true\nexport LLM_FIREWALL_RULES_DIR=./custom-rules\nexport LLM_FIREWALL_MIN_CONFIDENCE=0.8\n```\n\n## üß™ Best Practices\n\n### 1. Pattern Specificity\n- Make patterns as specific as possible to avoid false positives\n- Use word boundaries (`\\b`) when appropriate\n- Test against real-world data\n\n### 2. Confidence Levels\n- **0.9-1.0**: Very high confidence, minimal false positives\n- **0.7-0.9**: High confidence, some false positives possible\n- **0.5-0.7**: Medium confidence, review recommended\n- **0.3-0.5**: Low confidence, high false positive rate\n\n### 3. Test Cases\n- Include both positive and negative test cases\n- Test edge cases and variations\n- Verify replacement text is appropriate\n\n### 4. Documentation\n- Provide clear descriptions\n- Include pattern explanation\n- Document known limitations\n\n## üîí Security Considerations\n\n- **No Data Persistence**: Rules operate in memory only\n- **Pattern Validation**: All patterns are validated before use\n- **Error Handling**: Malformed rules are skipped gracefully\n- **Confidence Scoring**: Use confidence levels to balance security vs. usability\n\n## ü§ù Contributing Rules\n\n1. Fork the repository\n2. Create your rule file following the schema\n3. Add comprehensive test cases\n4. Validate and test your rules\n5. Submit a pull request with:\n   - Rule file in `rules/community/`\n   - Description of what it detects\n   - Use cases and examples\n\n## üìä Performance\n\n- Rules are loaded once at startup\n- Regex patterns are compiled and cached\n- Minimal performance impact (< 5ms overhead)\n- Supports thousands of rules efficiently\n\n## üêõ Troubleshooting\n\n### Common Issues\n\n1. **Rule not loading**\n   - Check JSON syntax with `llm-firewall rules validate`\n   - Verify file is in correct directory\n   - Check file permissions\n\n2. **Pattern not matching**\n   - Test pattern with `llm-firewall rules test-rules`\n   - Verify regex syntax\n   - Check flags (case sensitivity, global matching)\n\n3. **False positives**\n   - Increase confidence threshold\n   - Make pattern more specific\n   - Add negative test cases\n\n### Debug Mode\n\n```bash\nLLM_FIREWALL_LOG_LEVEL=debug llm-firewall start\n```\n\n## üìà Roadmap\n\n- [ ] Web UI for rule management\n- [ ] Rule marketplace/registry\n- [ ] Machine learning pattern suggestions\n- [ ] Integration with compliance frameworks\n- [ ] Real-time rule updates\n- [ ] Performance analytics dashboard